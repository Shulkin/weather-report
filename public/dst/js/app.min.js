angular.module("app.routes",[]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/map"),a.state("map",{url:"/map",templateUrl:"./views/ol3-map.html",controller:"MapCtrl as map"})}]);var app=angular.module("app",["ui.router","ui.bootstrap","app.routes","ol3.map.ctrl","ol3.map.service","cities.service","weather.data.service"]);angular.module("ol3.map.ctrl",[]).controller("MapCtrl",["$timeout","ol3Map","Cities","WeatherData",function(a,b,c,d){function e(c){a(function(){g.showMarkerInfo=c.length>0,g.markerInfo=c,b.updateSize()},10)}function f(){b.init({startLocation:[134.6,45.3]}),b.loadWeather(c.all()),b.addClick(e)}var g=this;g.showMarkerInfo=!1,f(),g.getIcon=d.getWeatherIconUrl,g.loadForecast=function(c){g.markerForecastInfo=null,g.showForecastLoader=!0,a(function(){b.loadForecast(c,function(a){g.markerForecastInfo=a,g.showForecastLoader=!1},function(a){g.showForecastLoader=!1})},2e3)}}]),angular.module("cities.service",[]).factory("Cities",[function(){return{all:function(){return[{id:"2013348",name:"Vladivostok"},{id:"2017364",name:"Russkiy"},{id:"2027142",name:"Barabash"},{id:"2016430",name:"Slavyanka"},{id:"2015310",name:"Fokino"},{id:"2019528",name:"Nakhodka"},{id:"2018116",name:"Partizansk"},{id:"2014006",name:"Ussuriysk"},{id:"2027468",name:"Arsenyev"}]},getIds:function(a){for(var b=[],c=0;c<a.length;c++)b.push(a[c].id);return b}}}]),angular.module("marker.style.service",[]).factory("Marker",[function(){return{getIconStyle:function(a){return new ol.style.Style({image:new ol.style.Icon({opacity:.9,src:a})})},getLabelStyle:function(a){return new ol.style.Style({text:new ol.style.Text({text:a,font:"17px Arial",textAlign:"center",textBaseline:"middle",fill:new ol.style.Fill({color:"#000000"}),stroke:new ol.style.Stroke({color:"#ffffff",width:2}),offsetY:21})})},getTemperatureStyle:function(a){return new ol.style.Style({text:new ol.style.Text({text:a,font:"17px Arial",textAlign:"left",textBaseline:"middle",fill:new ol.style.Fill({color:"#000000"}),stroke:new ol.style.Stroke({color:"#ffffff",width:2}),offsetX:21})})}}}]),angular.module("ol3.map.service",["marker.style.service"]).factory("ol3Map",["$timeout","Cities","WeatherData","Marker",function(a,b,c,d){var e={},f={zoom:6};return{map:e,init:function(a){a=angular.extend(f,a),e=new ol.Map({target:"map",layers:[new ol.layer.Tile({source:new ol.source.OSM})],view:new ol.View({center:ol.proj.transform(a.startLocation,"EPSG:4326","EPSG:3857"),zoom:a.zoom})})},updateSize:function(){a(function(){e.updateSize()},10)},addClick:function(a){var b=new ol.interaction.Select({condition:ol.events.condition.click,multi:!1});e.addInteraction(b),b.on("select",function(b){var c=[];b.target.getFeatures().forEach(function(a){c.push(a.get("weather"))}),a(c)})},loadWeather:function(a){c.getWeatherById({places:b.getIds(a)}).then(function(a){for(var b=a.list,f=[],g=0;g<b.length;g++){var h=b[g],i=h.coord.lat,j=h.coord.lon,k=new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform([j,i],"EPSG:4326","EPSG:3857")),weather:{data:h}});k.setStyle([d.getLabelStyle(h.name),d.getTemperatureStyle(Math.round(h.main.temp)+" Â°C"),d.getIconStyle(c.getWeatherIconUrl(h.weather[0].icon))]),f.push(k)}var l=new ol.source.Vector({features:f}),m=new ol.layer.Vector({source:l});e.addLayer(m)},function(a){console.log("Error "+a)})},loadForecast:function(a,b){c.getForecastById(a).then(function(a){b(a)},function(a){console.log("Error "+a),b(null)})}}}]),angular.module("weather.data.service",[]).factory("WeatherData",["$http",function(a){return{getWeatherById:function(b){return a.post("/api/weather",b).then(function(a){return a.data})},getForecastById:function(b){return a.get("/api/forecast/"+b).then(function(a){return a.data})},getWeatherIconUrl:function(a){return"http://openweathermap.org/img/w/"+a+".png"}}}]);